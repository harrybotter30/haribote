Next: [harib04g](harib04g.md), Previous: [harib04e](harib04e.md), Up: [Chapter7](chapter7.md)

----

# Chapter7

## harib04f

### 課題

マウスを有効化する。

### 学習

PS/2 マウス制御回路は PS/2 キーボード制御回路の中にあるので、キーボードコントローラに対して有効化命令を出す。

- キーボードコントローラ（KBC）が制御命令を受け付けられるかどうかを判定
    - ポート 0x64 から読み込んで下位 2 ビット目が 0 になっていれば受付可能
- KBC に対してモード設定を行うためにポート 0x64 に 0x60 を書き込み
    - マウス制御モードにするためにポート 0x60 に 0x47 を書き込む
- マウス制御回路にデータを送るためにポート 0x64 に 0xd4 を書き込み
    - マウスを有効にするためにポート 0x60 に 0xf4 を書き込む

```Assembly
init_keyboard:
	inb $0x64, %al
	andb $2, %al
	jnz init_keyboard

	movb $0x60, %al
	outb %al, $0x64

.L1:
	inb $0x64, %al
	andb $2, %al
	jnz .L1

	movb $0x47, %al
	outb %al, $0x60
	ret

enable_mouse:
	inb $0x64, %al
	andb $2, %al
	jnz enable_mouse

	mov $0xd4, %al
	out %al, $0x64

.L2:
	inb $0x64, %al
	andb $2, %al
	jnz .L2

	movb $0xf4, %al
	outb %al, $0x60
	ret
```

#### 参考

- [PS/2 Mouse Interfacing](https://web.archive.org/web/20180202180653/http://www.computer-engineering.org/ps2mouse/)
- [Mouse Input - OSDev Wiki](http://wiki.osdev.org/Mouse_Input)

Since both keyboard and mouse data is showing up to be read on port
0x60, it is necessary to be able to tell which is which. To tell if
there is any available data on port 0x60 at all, it is necessary to
read a byte from port 0x64. In that byte from port 0x64, bit number 0
(value=1) indicates that a byte is available to be read on port
0x60. An additional bit, bit number 5 (value=0x20), indicates that
this next byte came from the mouse, if the bit is set. If you look at
RBIL, it says that this "mouse bit" is MCA specific, but this is no
longer true. All PCs that support PS2 mice use this bit to indicate
that the incoming byte was generated by the auxiliary PS2 input port.

### 成果

- [bootpack.c](/bootpack.c)
    - マウス有効化処理追加

----

Next: [harib04g](harib04g.md), Previous: [harib04e](harib04e.md), Up: [Chapter7](chapter7.md)
